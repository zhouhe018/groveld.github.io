<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- meta info -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="format-detection" content="telephone=no">
    <!-- favicon and webapp behaviour -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#343a40">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Groveld">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon-1d3782f1d9f8bb4085f74100ed78b6dc672061a0fb9836f4aed38c227053ce68.png">
    <link rel="mask-icon" href="/assets/icons/safari-pinned-tab-0c565329ec571d7671bc3b7a20c867c13dc510c2964c06502dbae8407fb4d706.svg" color="#343a40">
    <!-- site info -->
    <meta name="description" content="Install a ready to use Postfix mail server with MySql backend for virtual users.">
    <meta name="author" content="groveld">
    <link rel="alternate" type="application/atom+xml" title="Martin Groeneveld" href="/atom.xml">
    <link rel="canonical" href="https://www.groveld.com/articles/postfix-with-mysql-backend-and-tls">
    <title>Postfix with MySQL backend and TLS - Martin Groeneveld</title>
    <!-- Bootstrap CSS and Custom CSS -->
    <link rel="preload" as="style" onload="this.rel='stylesheet'" href="/assets/style-9d67885ba200d7266fe52c6d238db8fda0d17ba39f492d3abc2d8ac59859515b.css">
    <style rel="stylesheet">:root{--blue: #007bff;--indigo: #6610f2;--purple: #6f42c1;--pink: #e83e8c;--red: #dc3545;--orange: #fd7e14;--yellow: #ffc107;--green: #28a745;--teal: #20c997;--cyan: #17a2b8;--white: #fff;--gray: #6c757d;--gray-dark: #343a40;--primary: #007bff;--secondary: #6c757d;--success: #28a745;--info: #17a2b8;--warning: #ffc107;--danger: #dc3545;--light: #f8f9fa;--dark: #343a40;--breakpoint-xs: 0;--breakpoint-sm: 576px;--breakpoint-md: 768px;--breakpoint-lg: 992px;--breakpoint-xl: 1200px;--font-family-sans-serif: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";--font-family-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}*,*::before,*::after{box-sizing:border-box}html{font-family:sans-serif;line-height:1.15;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;-ms-overflow-style:scrollbar}@-ms-viewport{width:device-width}nav{display:block}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;text-align:left;background-color:#fff}h1,h2{margin-top:0;margin-bottom:0.5rem}p{margin-top:0;margin-bottom:1rem}strong{font-weight:bolder}a{color:#007bff;text-decoration:none;background-color:transparent;-webkit-text-decoration-skip:objects}img{vertical-align:middle;border-style:none}button{border-radius:0}button{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button{overflow:visible}button{text-transform:none}button,html [type="button"]{-webkit-appearance:button}button::-moz-focus-inner,[type="button"]::-moz-focus-inner{padding:0;border-style:none}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}h1,h2{margin-bottom:0.5rem;font-family:inherit;font-weight:500;line-height:1.2;color:inherit}h1{font-size:2.5rem}h2{font-size:2rem}.container-fluid{width:100%;padding-right:15px;padding-left:15px;margin-right:auto;margin-left:auto}.row{display:flex;flex-wrap:wrap;margin-right:-15px;margin-left:-15px}.col{position:relative;width:100%;min-height:1px;padding-right:15px;padding-left:15px}.col{flex-basis:0;flex-grow:1;max-width:100%}.btn{display:inline-block;font-weight:400;text-align:center;white-space:nowrap;vertical-align:middle;border:1px solid transparent;padding:0.375rem 0.75rem;font-size:1rem;line-height:1.5;border-radius:0.25rem}.btn-primary{color:#fff;background-color:#007bff;border-color:#007bff}.collapse:not(.show){display:none}.nav-link{display:block;padding:0.5rem 1rem}.navbar{position:relative;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:0.5rem 1rem}.navbar>.container-fluid{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between}.navbar-brand{display:inline-block;padding-top:0.3125rem;padding-bottom:0.3125rem;margin-right:1rem;font-size:1.25rem;line-height:inherit;white-space:nowrap}.navbar-nav{display:flex;flex-direction:column;padding-left:0;margin-bottom:0;list-style:none}.navbar-nav .nav-link{padding-right:0;padding-left:0}.navbar-collapse{flex-basis:100%;flex-grow:1;align-items:center}.navbar-toggler{padding:0.25rem 0.75rem;font-size:1.25rem;line-height:1;background-color:transparent;border:1px solid transparent;border-radius:0.25rem}.navbar-toggler-icon{display:inline-block;width:1.5em;height:1.5em;vertical-align:middle;content:"";background:no-repeat center center;background-size:100% 100%}@media (max-width: 991.98px){.navbar-expand-lg>.container-fluid{padding-right:0;padding-left:0}}@media (min-width: 992px){.navbar-expand-lg{flex-flow:row nowrap;justify-content:flex-start}.navbar-expand-lg .navbar-nav{flex-direction:row}.navbar-expand-lg .navbar-nav .nav-link{padding-right:0.5rem;padding-left:0.5rem}.navbar-expand-lg>.container-fluid{flex-wrap:nowrap}.navbar-expand-lg .navbar-collapse{display:flex !important;flex-basis:auto}.navbar-expand-lg .navbar-toggler{display:none}}.navbar-dark .navbar-brand{color:#fff}.navbar-dark .navbar-nav .nav-link{color:rgba(255,255,255,0.5)}.navbar-dark .navbar-nav .nav-link.active{color:#fff}.navbar-dark .navbar-toggler{color:rgba(255,255,255,0.5);border-color:rgba(255,255,255,0.1)}.navbar-dark .navbar-toggler-icon{background-image:url("data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='rgba(255, 255, 255, 0.5)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E")}.card{position:relative;display:flex;flex-direction:column;min-width:0;word-wrap:break-word;background-color:#fff;background-clip:border-box;border:1px solid rgba(0,0,0,0.125);border-radius:0.25rem}.card-body{flex:1 1 auto;padding:1.25rem}.card-title{margin-bottom:0.75rem}.alert{position:relative;padding:0.75rem 1.25rem;margin-bottom:1rem;border:1px solid transparent;border-radius:0.25rem}.alert-info{color:#0c5460;background-color:#d1ecf1;border-color:#bee5eb}.alert-warning{color:#856404;background-color:#fff3cd;border-color:#ffeeba}.align-top{vertical-align:top !important}.bg-dark{background-color:#343a40 !important}.d-inline-block{display:inline-block !important}.fixed-top{position:fixed;top:0;right:0;left:0;z-index:1030}.mr-1{margin-right:0.25rem !important}.mb-2{margin-bottom:0.5rem !important}.my-3{margin-top:1rem !important}.my-3{margin-bottom:1rem !important}.ml-auto{margin-left:auto !important}*{margin:0;padding:0}body{font-family:'Poppins', sans-serif;background:#fafafa;padding-top:56px}p{font-family:'Poppins', sans-serif;font-size:1em;font-weight:300;line-height:1.5em;color:#333}a,a:hover,a:focus{color:inherit;text-decoration:none;transition:all 0.2s}#scrollUp{z-index:9999;display:none;position:fixed;right:20px;bottom:20px}#comments{display:none}.container-fluid{max-width:991.98px}@media (max-width: 991.98px){.nav-link{text-align:center;padding:1em;font-size:1.2em}.card{margin:-15px;border-radius:0}}
</style>
  </head>
  <body>
    
<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark mb-2">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">
      <img src="/assets/logo-30x30-330cd3f260f8df908f876c18845f9c4f38a981b6a830889259844ceff448027a.webp" width="30" height="30" class="d-inline-block align-top mr-1" alt="logo">
      Martin Groeneveld
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbar">
      <div class="navbar-nav ml-auto">
        <a class="nav-item nav-link active" href="/blog">Blog</a>
        <a class="nav-item nav-link" href="/about">About</a>
        <a class="nav-item nav-link" href="/contact">Contact</a>
      </div>
    </div>
  </div>
</nav>


    <div class="container-fluid">

  <div class="row">
    <div class="col">
      <div class="card my-3">
        <div class="card-body">
          <h1 class="card-title">Postfix with MySQL backend and TLS</h1>
          <p>In this tutorial we’ll install a ready to use Postfix mail server with MySql backend for virtual users. Notice that this tutorial only covers installing the SMTP server (not POP3 and IMAP). Click here for a tutorial on installing Courier POP3 and IMAP services.</p>

<p>Once installed and configured, you can easily create your own admin system to modifiy the domains and users because the table structure is very simple.</p>

<p>This tutorial has been tested on Debian etch and lenny</p>

<h3 id="install-the-postfix-mail-server-mysql-server-and-other-required-packages">Install the Postfix mail server, MySql server and other required packages</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>postfix postfix-mysql sasl2-bin libsasl2-modules mysql-client mysql-server libpam-mysql
</code></pre></div></div>

<p>In the configuration wizzard for Postfix select and input the following;</p>

<p>General type of mail configuration <strong>-&gt;</strong> <code class="highlighter-rouge">Internet Site</code></p>

<p>System mail name <strong>-&gt;</strong> <code class="highlighter-rouge">server.domain.com</code> <em>(your server host name)</em></p>

<h3 id="create-a-mysql-database-that-will-contain-domains-and-mappings-and-create-a-user-that-has-read-privileges-on-it">Create a MySql database that will contain domains and mappings and create a user that has read privileges on it</h3>
<p>Execute the following SQL queries to create the table structure:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">domains</span> <span class="p">(</span>
<span class="k">domain</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">63</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="k">domain</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">forwardings</span> <span class="p">(</span>
<span class="n">email</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">destination</span> <span class="n">text</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">transport</span> <span class="p">(</span>
<span class="k">domain</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">transport</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="k">domain</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="p">(</span>
<span class="n">email</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">password</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">quota</span> <span class="n">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="n">unsigned</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">default</span> <span class="s1">'102400'</span><span class="p">,</span>
<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">MyISAM</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="populate-tables-with-some-test-data">Populate tables with some test data</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">domains</span> <span class="p">(</span><span class="k">domain</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">mydomain</span><span class="p">.</span><span class="n">com</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'address@mydomain.com'</span><span class="p">,</span> <span class="n">ENCRYPT</span><span class="p">(</span><span class="s1">'mypassword'</span><span class="p">));</span>
<span class="n">INESRT</span> <span class="k">INTO</span> <span class="n">forwardings</span> <span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">desination</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'myforward@mydomain.com'</span><span class="p">,</span> <span class="s1">'address@mydomain.com, otheraddress@mydomain.com'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">transport</span> <span class="p">(</span><span class="k">domain</span><span class="p">,</span> <span class="n">transport</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'transport.com'</span><span class="p">,</span> <span class="s1">'smtp:mail.transport.com'</span><span class="p">);</span>
</code></pre></div></div>

<p>If you want to create a user or forwarding for a domain, you must add it to the domains table. Using the transport table you can forward all mail received to another mail server, when using the transport table you don’t have to add the domain to the domains table.</p>

<h3 id="create-mysql-mappings-for-postfix-replace-mysql_-with-your-mysql-credentials">Create MySql mappings for Postfix. Replace {mysql_*} with your MySql credentials</h3>
<p><code class="highlighter-rouge">nano /etc/postfix/mysql-virtual_domains.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hosts</span> = {<span class="n">mysql_host</span>}
<span class="n">user</span> = {<span class="n">mysql_username</span>}
<span class="n">password</span> = {<span class="n">mysql_password</span>}
<span class="n">dbname</span> = {<span class="n">mysql_database</span>}
<span class="n">table</span> = <span class="n">domains</span>
<span class="n">select_field</span> = <span class="s1">'virtual'</span>
<span class="n">where_field</span> = <span class="n">domain</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">nano /etc/postfix/mysql-virtual_forwardings.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hosts</span> = {<span class="n">mysql_host</span>}
<span class="n">user</span> = {<span class="n">mysql_username</span>}
<span class="n">password</span> = {<span class="n">mysql_password</span>}
<span class="n">dbname</span> = {<span class="n">mysql_database</span>}
<span class="n">table</span> = <span class="n">forwardings</span>
<span class="n">select_field</span> = <span class="n">destination</span>
<span class="n">where_field</span> = <span class="n">email</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">nano /etc/postfix/mysql-virtual_mailboxes.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hosts</span> = {<span class="n">mysql_host</span>}
<span class="n">user</span> = {<span class="n">mysql_username</span>}
<span class="n">password</span> = {<span class="n">mysql_password</span>}
<span class="n">dbname</span> = {<span class="n">mysql_database</span>}
<span class="n">table</span> = <span class="n">users</span>
<span class="n">select_field</span> = <span class="n">CONCAT</span>(<span class="n">SUBSTRING_INDEX</span>(<span class="n">email</span>,<span class="s1">'@'</span>,-<span class="m">1</span>),<span class="s1">'/'</span>,<span class="n">SUBSTRING_INDEX</span>(<span class="n">email</span>,<span class="s1">'@'</span>,<span class="m">1</span>),<span class="s1">'/'</span>)
<span class="n">where_field</span> = <span class="n">email</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">nano /etc/postfix/mysql-virtual_email2email.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hosts</span> = {<span class="n">mysql_host</span>}
<span class="n">user</span> = {<span class="n">mysql_username</span>}
<span class="n">password</span> = {<span class="n">mysql_password</span>}
<span class="n">dbname</span> = {<span class="n">mysql_database</span>}
<span class="n">table</span> = <span class="n">users</span>
<span class="n">select_field</span> = <span class="n">email</span>
<span class="n">where_field</span> = <span class="n">email</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">nano /etc/postfix/mysql-virtual_transports.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hosts</span> = {<span class="n">mysql_host</span>}
<span class="n">user</span> = {<span class="n">mysql_username</span>}
<span class="n">password</span> = {<span class="n">mysql_password</span>}
<span class="n">dbname</span> = {<span class="n">mysql_database</span>}
<span class="n">table</span> = <span class="n">transport</span>
<span class="n">select_field</span> = <span class="n">transport</span>
<span class="n">where_field</span> = <span class="n">domain</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">nano /etc/postfix/mysql-virtual_mailbox_limit_maps.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hosts</span> = {<span class="n">mysql_host</span>}
<span class="n">user</span> = {<span class="n">mysql_username</span>}
<span class="n">password</span> = {<span class="n">mysql_password</span>}
<span class="n">dbname</span> = {<span class="n">mysql_database</span>}
<span class="n">table</span> = <span class="n">users</span>
<span class="n">select_field</span> = <span class="n">quota</span>
<span class="n">where_field</span> = <span class="n">email</span>
</code></pre></div></div>

<h3 id="set-correct-permissions-on-the-newly-created-files-and-allow-postfix-to-read-the-files">Set correct permissions on the newly created files and allow Postfix to read the files</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">chmod </span>640 /etc/postfix/mysql-virtual_<span class="k">*</span>
<span class="nb">chgrp </span>postfix /etc/postfix/mysql-virtual_<span class="k">*</span>
</code></pre></div></div>

<h3 id="create-a-new-user-and-group-named-vmail-all-incoming-mail-will-be-stored-in-this-users-home-directory">Create a new user and group named vmail. All incoming mail will be stored in this users home directory</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>groupadd <span class="nt">-g</span> 5000 vmail
useradd <span class="nt">-g</span> vmail <span class="nt">-u</span> 5000 vmail <span class="nt">-d</span> /home/vmail <span class="nt">-m</span>
</code></pre></div></div>

<h3 id="configure-postfix-to-use-sasl-for-user-authentication-and-tls-for-encryption">Configure Postfix to use SASL for user authentication and TLS for encryption</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>postconf <span class="nt">-e</span> <span class="s1">'smtpd_sasl_auth_enable = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'broken_sasl_auth_clients = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'smtpd_recipient_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination'</span>
postconf <span class="nt">-e</span> <span class="s1">'smtpd_use_tls = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'smtpd_tls_cert_file = /etc/postfix/smtpd.cert'</span>
postconf <span class="nt">-e</span> <span class="s1">'smtpd_tls_key_file = /etc/postfix/smtpd.key'</span>
postconf <span class="nt">-e</span> <span class="s1">'smtpd_sasl_local_domain = $myhostname'</span>
postconf <span class="nt">-e</span> <span class="s1">'smtpd_sasl_security_options = noanonymous'</span>
</code></pre></div></div>

<h3 id="configure-postfix-to-use-the-mysql-database-to-find-virtual-users-where-to-store-mail-and-what-to-do-for-users-over-quota">Configure Postfix to use the MySql database to find virtual users, where to store mail and what to do for users over quota</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>postconf <span class="nt">-e</span> <span class="s1">'virtual_alias_domains ='</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_alias_maps = proxy:mysql:/etc/postfix/mysql-virtual_forwardings.cf, mysql:/etc/postfix/mysql-virtual_email2email.cf'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_mailbox_domains = proxy:mysql:/etc/postfix/mysql-virtual_domains.cf'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_mailbox_maps = proxy:mysql:/etc/postfix/mysql-virtual_mailboxes.cf'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_mailbox_base = /home/vmail'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_uid_maps = static:5000'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_gid_maps = static:5000'</span>
postconf <span class="nt">-e</span> <span class="s1">'transport_maps = proxy:mysql:/etc/postfix/mysql-virtual_transports.cf'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_create_maildirsize = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_mailbox_extended = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_mailbox_limit_maps = proxy:mysql:/etc/postfix/mysql-virtual_mailbox_limit_maps.cf'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_mailbox_limit_override = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_maildir_limit_message = "The user you are trying to reach is over quota."'</span>
postconf <span class="nt">-e</span> <span class="s1">'virtual_overquota_bounce = yes'</span>
postconf <span class="nt">-e</span> <span class="s1">'proxy_read_maps = $local_recipient_maps $mydestination $virtual_alias_maps $virtual_alias_domains $virtual_mailbox_maps $virtual_mailbox_domains $relay_recipient_maps $relay_domains $canonical_maps $sender_canonical_maps $recipient_canonical_maps $relocated_maps $transport_maps $mynetworks $virtual_mailbox_limit_maps'</span>
</code></pre></div></div>

<h3 id="create-a-self-signed-certificate-to-encrypt-connections">Create a self signed certificate to encrypt connections</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-new</span> <span class="nt">-outform</span> PEM <span class="nt">-out</span> /etc/postfix/smtpd.cert <span class="nt">-newkey</span> rsa:2048 <span class="nt">-nodes</span> <span class="nt">-keyout</span> /etc/postfix/smtpd.key <span class="nt">-keyform</span> PEM <span class="nt">-days</span> 3650 <span class="nt">-x509</span>
<span class="nb">chmod </span>640 /etc/postfix/smtpd.key
</code></pre></div></div>

<h3 id="make-postfix-listen-on-port-465-for-secure-smtp-connections">Make Postfix listen on port 465 for secure smtp connections</h3>
<p><code class="highlighter-rouge">nano /etc/postfix/master.cf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">smtps</span> <span class="n">inet</span> <span class="n">n</span> - - - - <span class="n">smtpd</span>
-<span class="n">o</span> <span class="n">smtpd_tls_wrappermode</span>=<span class="n">yes</span>
-<span class="n">o</span> <span class="n">smtpd_sasl_auth_enable</span>=<span class="n">yes</span>
-<span class="n">o</span> <span class="n">smtpd_client_restrictions</span>=<span class="n">permit_sasl_authenticated</span>,<span class="n">reject</span>
</code></pre></div></div>

<h3 id="force-sasl-to-store-the-pid-files-in-a-location-where-postfix-can-read-them">Force SASL to store the PID files in a location where Postfix can read them</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> /var/spool/postfix/var/run/saslauthd
</code></pre></div></div>

<p>Edit SASL config to enable the daemon and make it use the new PID file location (<code class="highlighter-rouge">nano /etc/default/saslauthd</code>)</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">START</span>=<span class="n">yes</span>
<span class="n">OPTIONS</span>=<span class="s2">"-c -m /var/spool/postfix/var/run/saslauthd -r"</span>
</code></pre></div></div>

<p>Edit the init file for SASL (<code class="highlighter-rouge">nano /etc/init.d/saslauthd</code>)</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PIDFILE</span>=<span class="s2">"/var/spool/postfix/var/run/${NAME}/saslauthd.pid"</span>
</code></pre></div></div>

<h3 id="insert-mysql-credentials-for-pam-nano-etcpamdsmtp">Insert MySql credentials for PAM (nano /etc/pam.d/smtp)**</h3>
<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">auth</span> <span class="n">required</span> <span class="n">pam_mysql</span>.<span class="n">so</span> <span class="n">user</span>={<span class="n">mysql_username</span>} <span class="n">passwd</span>={<span class="n">mysql_password</span>} <span class="n">host</span>={<span class="n">mysql_host</span>} <span class="n">db</span>={<span class="n">mysql_database</span>} <span class="n">table</span>=<span class="n">users</span> <span class="n">usercolumn</span>=<span class="n">email</span> <span class="n">passwdcolumn</span>=<span class="n">password</span> <span class="n">crypt</span>=<span class="m">1</span>
<span class="n">account</span> <span class="n">sufficient</span> <span class="n">pam_mysql</span>.<span class="n">so</span> <span class="n">user</span>={<span class="n">mysql_username</span>} <span class="n">passwd</span>={<span class="n">mysql_password</span>} <span class="n">host</span>={<span class="n">mysql_host</span>} <span class="n">db</span>={<span class="n">mysql_database</span>} <span class="n">table</span>=<span class="n">users</span> <span class="n">usercolumn</span>=<span class="n">email</span> <span class="n">passwdcolumn</span>=<span class="n">password</span> <span class="n">crypt</span>=<span class="m">1</span>
</code></pre></div></div>

<h3 id="config-sasl-for-postfix-and-specify-mysql-credentials">Config SASL for Postfix and specify MySql credentials</h3>
<p><code class="highlighter-rouge">nano /etc/postfix/sasl/smtpd.conf</code></p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwcheck_method</span>: <span class="n">saslauthd</span>
<span class="n">mech_list</span>: <span class="n">plain</span> <span class="n">login</span>
<span class="n">allow_plaintext</span>: <span class="n">true</span>
<span class="n">auxprop_plugin</span>: <span class="n">mysql</span>
<span class="n">sql_hostnames</span>: {<span class="n">mysql_host</span>}
<span class="n">sql_user</span>: {<span class="n">mysql_username</span>}
<span class="n">sql_passwd</span>: {<span class="n">mysql_password</span>}
<span class="n">sql_database</span>: {<span class="n">mysql_database</span>}
<span class="n">sql_select</span>: <span class="n">select</span> <span class="n">password</span> <span class="n">from</span> <span class="n">users</span> <span class="n">where</span> <span class="n">email</span> = <span class="s1">'%u'</span>
</code></pre></div></div>

<h3 id="add-the-postfix-user-to-the-sasl-group-allowing-postfix-to-communicate-with-sasl">Add the Postfix user to the SASL group allowing Postfix to communicate with SASL</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>adduser postfix sasl
</code></pre></div></div>

<h3 id="restart-postfix-and-sasl">Restart Postfix and SASL</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/postfix restart
/etc/init.d/saslauthd restart
</code></pre></div></div>

<p>You’re all done. Now you can connect to ports 25 and 465 to sent mails to your virtual users specified in the MySql database. When authenticating with your e-mail client, use the full e-mail address as the username.</p>

        </div>
      </div>
    </div>
  </div>

  

</div>


    <button type="button" class="btn btn-primary" id="scrollUp">Scroll to top</button>

    <footer class="container-fluid my-3">
      <div class="row">
        <div class="col">
          <div class="small text-center">
            &copy; 2018 Martin Groeneveld &bull; <a href="/legal/terms">Terms</a> &bull; <a href="/legal/privacy">Privacy</a> &bull; <a href="/legal/cookies">Cookies</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- jQuery first, then Popper.js, then Bootstrap JS, then custom scripts -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="/assets/main-b06086bbcd2245668714675a5a7f84a27ce884690006410f47f61695b4a52959.js"></script>
  </body>
</html>
